name: Release to Maven Central

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v5.2.9

permissions:
  contents: read

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        server-id: central
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        
    - name: é…ç½® GPG
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        # ä½¿ç”¨æ— å¯†ç  GPG å¯†é’¥ï¼Œæ— éœ€é…ç½® passphrase
        
    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"
        
    - name: æ›´æ–°ç‰ˆæœ¬å·
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        # æ›´æ–°æ ¹ pom.xml ç‰ˆæœ¬
        mvn versions:set -DnewVersion=$VERSION -DgenerateBackupPoms=false
        # æ›´æ–°å­æ¨¡å—ç‰ˆæœ¬
        mvn versions:update-child-modules -DgenerateBackupPoms=false
        
    - name: ç¼–è¯‘
      run: mvn clean compile -pl jiguang-sdk
      
    - name: è°ƒè¯•è®¤è¯ä¿¡æ¯
      run: |
        echo "æ­£åœ¨éªŒè¯ Maven Central Portal è®¤è¯é…ç½®..."
        echo "ç”¨æˆ·å: ${{ secrets.CENTRAL_USERNAME }}" | sed 's/./*/g'
        echo "Token: ${{ secrets.CENTRAL_TOKEN }}" | cut -c1-4 | sed 's/.$/***/'
        
    - name: å‘å¸ƒåˆ° Maven Central
      run: |
        echo "å¼€å§‹å‘å¸ƒåˆ° Maven Central Portal..."
        mvn clean deploy -P release -pl jiguang-sdk -DskipTests -X
      env:
        MAVEN_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.CENTRAL_TOKEN }}
        GPG_TTY: $(tty)
        
    - name: å‘å¸ƒç»“æœé€šçŸ¥
      if: success()
      run: |
        echo "âœ… jiguang-sdk v${{ steps.get_version.outputs.VERSION }} å·²æˆåŠŸå‘å¸ƒåˆ° Maven Central"
        echo "ğŸ“¦ å¯é€šè¿‡ä»¥ä¸‹ä¾èµ–ä½¿ç”¨ï¼š"
        echo "<dependency>"
        echo "    <groupId>io.github.jpush</groupId>"
        echo "    <artifactId>jiguang-sdk</artifactId>"
        echo "    <version>${{ steps.get_version.outputs.VERSION }}</version>"
        echo "</dependency>"
        
    - name: å¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
